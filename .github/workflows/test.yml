name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-tcl9:
    name: test (ruby ${{ matrix.ruby }}, tcl 9.0)
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        ruby: ['3.4']
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    # Restore cache from artifact (90-day retention)
    - name: Download build cache
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: docker-cache-ruby${{ matrix.ruby }}-tcl9
        path: cache-mount

    - name: Restore Docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        cache-map: |
          {
            "var-cache-apt": "/var/cache/apt",
            "var-lib-apt": "/var/lib/apt",
            "bundle-cache": "/bundle-cache",
            "mise-dl": "/mise-dl",
            "mise-cache": "/mise-cache",
            "mise-xdg-cache": "/root/.cache/mise",
            "mise-downloads": "/root/.local/share/mise/downloads"
          }
        skip-extraction: false
        builder: ${{ steps.buildx.outputs.name }}

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ci-test
        build-args: |
          RUBY_VERSION=${{ matrix.ruby }}
          TCL_VERSION=9.0
        builder: ${{ steps.buildx.outputs.name }}
        load: true
        tags: tk-ci-test-9:latest
        cache-from: type=gha,scope=ruby${{ matrix.ruby }}-tcl9
        cache-to: type=gha,mode=max,scope=ruby${{ matrix.ruby }}-tcl9

    # Save cache as artifact (90-day retention)
    - name: Upload build cache
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-cache-ruby${{ matrix.ruby }}-tcl9
        path: cache-mount
        retention-days: 90
        overwrite: true

    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/screenshots:/app/screenshots \
          -v ${{ github.workspace }}/coverage:/app/coverage \
          -e TCL_VERSION=9.0 \
          -e COVERAGE=1 \
          tk-ci-test-9:latest

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-ruby${{ matrix.ruby }}-tcl9
        path: coverage/
        retention-days: 30

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-ruby${{ matrix.ruby }}-tcl9
        path: screenshots/unverified/
        retention-days: 30

    - name: Upload screenshot diffs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-diffs-ruby${{ matrix.ruby }}-tcl9
        path: |
          screenshots/diffs/
          screenshots/logs/
        retention-days: 7

  test-tcl8:
    name: test (ruby ${{ matrix.ruby }}, tcl 8.6)
    runs-on: ubuntu-24.04
    needs: test-tcl9
    strategy:
      matrix:
        ruby: ['3.4']
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    # Restore cache - try tcl9's cache first (has compiled Ruby), then own cache
    - name: Download tcl9 build cache (shared Ruby)
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: docker-cache-ruby${{ matrix.ruby }}-tcl9
        path: cache-mount

    - name: Download own build cache
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: docker-cache-ruby${{ matrix.ruby }}-tcl8
        path: cache-mount

    - name: Restore Docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        cache-map: |
          {
            "var-cache-apt": "/var/cache/apt",
            "var-lib-apt": "/var/lib/apt",
            "bundle-cache": "/bundle-cache",
            "mise-dl": "/mise-dl",
            "mise-cache": "/mise-cache",
            "mise-xdg-cache": "/root/.cache/mise",
            "mise-downloads": "/root/.local/share/mise/downloads"
          }
        skip-extraction: false
        builder: ${{ steps.buildx.outputs.name }}

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ci-test
        build-args: |
          RUBY_VERSION=${{ matrix.ruby }}
          TCL_VERSION=8.6
        builder: ${{ steps.buildx.outputs.name }}
        load: true
        tags: tk-ci-test-8:latest
        cache-from: type=gha,scope=ruby${{ matrix.ruby }}-tcl8
        cache-to: type=gha,mode=max,scope=ruby${{ matrix.ruby }}-tcl8

    # Save cache as artifact (90-day retention)
    - name: Upload build cache
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-cache-ruby${{ matrix.ruby }}-tcl8
        path: cache-mount
        retention-days: 90
        overwrite: true

    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/screenshots:/app/screenshots \
          -e TCL_VERSION=8.6 \
          tk-ci-test-8:latest

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-ruby${{ matrix.ruby }}-tcl8
        path: screenshots/unverified/
        retention-days: 30

    - name: Upload screenshot diffs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-diffs-ruby${{ matrix.ruby }}-tcl8
        path: |
          screenshots/diffs/
          screenshots/logs/
        retention-days: 7
