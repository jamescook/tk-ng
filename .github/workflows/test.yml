name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-tcl9:
    name: test (ruby ${{ matrix.ruby }}, tcl 9.0)
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        ruby: ['3.4']
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    - name: Restore build cache
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: docker-cache-tcl9
        path: cache-mount

    # cache-dir is ignored when cache-map is provided, so we prefix paths explicitly
    - name: Inject/extract Docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        cache-map: |
          {
            "cache-mount/var-cache-apt": "/var/cache/apt",
            "cache-mount/var-lib-apt": "/var/lib/apt",
            "cache-mount/bundle-cache": "/bundle-cache"
          }
        save-always: true
        builder: ${{ steps.buildx.outputs.name }}

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ci-test
        build-args: |
          RUBY_VERSION=${{ matrix.ruby }}
          TCL_VERSION=9.0
        builder: ${{ steps.buildx.outputs.name }}
        load: true
        tags: tk-ci-test-9:latest

    # Debug: see what cache-dance created
    - name: Debug cache directory
      if: always()
      run: |
        echo "=== Current directory ==="
        ls -la
        echo "=== cache-mount directory ==="
        ls -la cache-mount 2>/dev/null || echo "cache-mount does not exist"
        echo "=== cache-mount contents (recursive) ==="
        find cache-mount -type f 2>/dev/null | head -20 || echo "no files"

    - name: Upload build cache
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-cache-tcl9
        path: cache-mount
        retention-days: 90
        overwrite: true
        if-no-files-found: warn

    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/screenshots:/app/screenshots \
          -v ${{ github.workspace }}/coverage:/app/coverage \
          -e TCL_VERSION=9.0 \
          -e COVERAGE=1 \
          tk-ci-test-9:latest

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-ruby${{ matrix.ruby }}-tcl9
        path: coverage/
        retention-days: 30

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-ruby${{ matrix.ruby }}-tcl9
        path: screenshots/unverified/
        retention-days: 30

    - name: Upload screenshot diffs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-diffs-ruby${{ matrix.ruby }}-tcl9
        path: |
          screenshots/diffs/
          screenshots/logs/
        retention-days: 7

  test-tcl8:
    name: test (ruby ${{ matrix.ruby }}, tcl 8.6)
    runs-on: ubuntu-24.04
    needs: test-tcl9
    strategy:
      matrix:
        ruby: ['3.4']
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    # Try tcl9's cache first (shared apt/gems), then own cache
    - name: Restore tcl9 build cache
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: docker-cache-tcl9
        path: cache-mount

    - name: Restore own build cache
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: docker-cache-tcl8
        path: cache-mount

    # cache-dir is ignored when cache-map is provided, so we prefix paths explicitly
    - name: Inject/extract Docker cache mounts
      uses: reproducible-containers/buildkit-cache-dance@v3
      with:
        cache-map: |
          {
            "cache-mount/var-cache-apt": "/var/cache/apt",
            "cache-mount/var-lib-apt": "/var/lib/apt",
            "cache-mount/bundle-cache": "/bundle-cache"
          }
        save-always: true
        builder: ${{ steps.buildx.outputs.name }}

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile.ci-test
        build-args: |
          RUBY_VERSION=${{ matrix.ruby }}
          TCL_VERSION=8.6
        builder: ${{ steps.buildx.outputs.name }}
        load: true
        tags: tk-ci-test-8:latest

    - name: Upload build cache
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-cache-tcl8
        path: cache-mount
        retention-days: 90
        overwrite: true
        if-no-files-found: warn

    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/screenshots:/app/screenshots \
          -e TCL_VERSION=8.6 \
          tk-ci-test-8:latest

    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-ruby${{ matrix.ruby }}-tcl8
        path: screenshots/unverified/
        retention-days: 30

    - name: Upload screenshot diffs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-diffs-ruby${{ matrix.ruby }}-tcl8
        path: |
          screenshots/diffs/
          screenshots/logs/
        retention-days: 7
