# syntax=docker/dockerfile:1
# Test Dockerfile for Tcl/Tk on Ubuntu 25.04
# Using 25.04 (plucky) instead of 24.04 LTS because it has:
# - Tcl/Tk 9.0.1 packages
# - BWidget 1.10.1 with Tcl 9 support
# - libtk-img 2.0.1 with Tcl 9 support
#
# Usage:
#   Tcl/Tk 9.0 (default):
#     docker build -f Dockerfile.ci-test -t tk-ci-test-9 .
#
#   Tcl/Tk 8.6:
#     docker build -f Dockerfile.ci-test --build-arg TCL_VERSION=8.6 -t tk-ci-test-8 .
#
#   Ruby 4.0 (future):
#     docker build -f Dockerfile.ci-test --build-arg RUBY_VERSION=4.0 -t tk-ci-test-ruby4 .
#
#   Run tests:
#     docker run --rm -v $(pwd)/screenshots:/app/screenshots tk-ci-test-9
#
#   Or use rake tasks:
#     rake docker:test                    # Test with Tcl 9.0
#     TCL_VERSION=8.6 rake docker:test    # Test with Tcl 8.6
#     rake docker:clean                   # Remove dangling images

FROM ubuntu:25.04

ENV DEBIAN_FRONTEND=noninteractive

# Skip docs/man pages to speed up apt installs
RUN echo 'path-exclude=/usr/share/doc/*' > /etc/dpkg/dpkg.cfg.d/excludes && \
    echo 'path-exclude=/usr/share/man/*' >> /etc/dpkg/dpkg.cfg.d/excludes && \
    echo 'path-exclude=/usr/share/locale/*' >> /etc/dpkg/dpkg.cfg.d/excludes

# Base dependencies (no Ruby - installed via mise below)
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    ca-certificates \
    git \
    xvfb \
    imagemagick \
    perceptualdiff \
    fonts-noto-color-emoji \
    fonts-noto-cjk \
    bwidget \
    wget \
    libyaml-dev \
    libffi-dev \
    libreadline-dev \
    zlib1g-dev \
    libssl-dev

# Install mise (Ruby version manager)
RUN curl https://mise.run | sh
ENV PATH="/root/.local/bin:${PATH}"

# Install Ruby via mise (cache compiled installs across builds)
ARG RUBY_VERSION=3.4
RUN --mount=type=cache,target=/mise-cache \
    --mount=type=cache,target=/root/.cache/mise \
    --mount=type=cache,target=/root/.local/share/mise/downloads \
    mkdir -p /root/.local/share/mise/installs && \
    if [ -d /mise-cache/ruby ]; then \
        echo "Restoring cached Ruby install..." && \
        cp -a /mise-cache/ruby /root/.local/share/mise/installs/; \
    fi && \
    mise install ruby@${RUBY_VERSION} && \
    cp -a /root/.local/share/mise/installs/ruby /mise-cache/ # v2
RUN mise use -g ruby@${RUBY_VERSION}
ENV PATH="/root/.local/share/mise/shims:${PATH}"

# Layer 2: Tcl/Tk version-specific packages
ARG TCL_VERSION=9.0
ENV TCL_VERSION=${TCL_VERSION}

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    if [ "${TCL_VERSION}" = "8.6" ]; then \
        apt-get update && apt-get install -y --no-install-recommends tcl-dev tk-dev libtk-img; \
    else \
        # Ubuntu 25.04's libtk-img 2.0.1 was built for Tcl 8 only (no libtcl9* files).
        # Debian sid has libtk-img 2.1.0 with Tcl 9 support, so we install both
        # libtk-img and its libjpeg62-turbo dependency from Debian.
        # Use dpkg --print-architecture to get correct arch (amd64 for CI, arm64 for Apple Silicon).
        apt-get update && apt-get install -y --no-install-recommends tcl9.0-dev tk9.0-dev libtommath-dev && \
        ARCH=$(dpkg --print-architecture) && \
        wget -q -O /tmp/libjpeg62-turbo.deb "http://ftp.us.debian.org/debian/pool/main/libj/libjpeg-turbo/libjpeg62-turbo_2.1.5-4_${ARCH}.deb" && \
        wget -q -O /tmp/libtk-img.deb "http://ftp.us.debian.org/debian/pool/main/libt/libtk-img/libtk-img_2.1.0+dfsg1-1_${ARCH}.deb" && \
        dpkg -i /tmp/libjpeg62-turbo.deb /tmp/libtk-img.deb && \
        rm /tmp/libjpeg62-turbo.deb /tmp/libtk-img.deb; \
    fi

ENV TCLLIBPATH=/usr/share/tcltk

# Ubuntu 25.04 pkg-config bug: tk9.0.pc requires "tcl" but only tcl9.0.pc exists
RUN if [ "${TCL_VERSION}" != "8.6" ]; then \
        MULTIARCH=$(dpkg-architecture -qDEB_HOST_MULTIARCH) && \
        ln -sf tcl9.0.pc /usr/lib/${MULTIARCH}/pkgconfig/tcl.pc && \
        ln -sf tk9.0.pc /usr/lib/${MULTIARCH}/pkgconfig/tk.pc; \
    fi

# Copy source and install dependencies
WORKDIR /app
COPY . .

# Install gems (cache compiled gems across builds)
ENV BUNDLE_PATH=/usr/local/bundle
RUN --mount=type=cache,target=/bundle-cache \
    gem install bundler --no-document && \
    if [ -d /bundle-cache/gems ]; then \
        echo "Restoring cached gems..." && \
        mkdir -p $BUNDLE_PATH && \
        cp -a /bundle-cache/* $BUNDLE_PATH/; \
    fi && \
    bundle install && \
    cp -a $BUNDLE_PATH/* /bundle-cache/

# Compile the extension based on version
# Note: Use dpkg-architecture to get correct lib path for arm64 vs x86_64
RUN MULTIARCH=$(dpkg-architecture -qDEB_HOST_MULTIARCH) && \
    if [ "${TCL_VERSION}" = "8.6" ]; then \
        bundle exec rake compile -- --with-tcltkversion=8.6 \
            --with-tcl-lib=/usr/lib/${MULTIARCH} \
            --with-tk-lib=/usr/lib/${MULTIARCH} \
            --with-tcl-include=/usr/include/tcl8.6 \
            --with-tk-include=/usr/include/tcl8.6; \
    else \
        bundle exec rake compile -- --with-tcltkversion=9.0 \
            --with-tcl-lib=/usr/lib/${MULTIARCH} \
            --with-tk-lib=/usr/lib/${MULTIARCH} \
            --with-tcl-include=/usr/include/tcl9.0 \
            --with-tk-include=/usr/include/tk9.0; \
    fi

# Screenshots will be in /app/screenshots/unverified/linux/tcl{version}/
CMD ["bash", "-c", "Xvfb :99 -screen 0 1024x768x24 & sleep 1 && DISPLAY=:99 bundle exec rake test"]
